name: Multi-Platform Release with Docker Build

on:
  push:
    tags:
      - "v*"

jobs:
  # 통합 빌드 job - 모든 플랫폼을 한 번에 빌드
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # x86_64 builds only (ARM64 temporarily disabled due to timeout issues)
          - dockerfile: debian.bookworm.Dockerfile
            platform: debian.bookworm
            arch: amd64
          - dockerfile: debian.trixie.Dockerfile
            platform: debian.trixie
            arch: amd64
          - dockerfile: ubuntu.2404.Dockerfile
            platform: ubuntu.2404
            arch: amd64
          - dockerfile: fedora.40.Dockerfile
            platform: fedora.40
            arch: amd64
          - dockerfile: fedora.latest.Dockerfile
            platform: fedora.latest
            arch: amd64
          - dockerfile: opensuse.Dockerfile
            platform: opensuse
            arch: amd64
          - dockerfile: arch.Dockerfile
            platform: arch
            arch: amd64


    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-platform builds
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        if: matrix.arch == 'arm64'
        uses: docker/setup-buildx-action@v3

      - name: Build packages with docker build script
        run: |
          # 개선된 빌드 스크립트 사용
          chmod +x scripts/build-docker.sh
          
          # Dockerfile 이름에서 .Dockerfile 확장자 제거
          DOCKERFILE_NAME="${{ matrix.dockerfile }}"
          PLATFORM_NAME="${DOCKERFILE_NAME%.Dockerfile}"
          
          echo "Building packages for platform: $PLATFORM_NAME (architecture: ${{ matrix.arch }})"
          
          # ARM64 빌드의 경우 추가 설정
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            echo "Setting up ARM64 build environment..."
            # Docker에서 ARM64 빌드를 위한 환경 설정
            export DOCKER_CLI_EXPERIMENTAL=enabled
          fi
          
          ./scripts/build-docker.sh "$PLATFORM_NAME"
          
          # 생성된 패키지 확인
          echo "=== Generated packages for $PLATFORM_NAME ==="
          find dist/ -name "*" -type f | sort
          ls -la dist/$PLATFORM_NAME/ || echo "No packages found for $PLATFORM_NAME"

      - name: Upload platform artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist/${{ matrix.platform }}/*
          retention-days: 1

  # 릴리즈 생성
  create-release:
    needs: build-packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-packages/
          merge-multiple: false

      - name: Organize packages for release
        run: |
          mkdir -p final-packages
          
          # 각 플랫폼별 패키지를 final-packages에 정리
          for platform_dir in release-packages/packages-*; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/packages-//')
              echo "Processing platform: $platform_name"
              
              # 플랫폼별 패키지를 final-packages로 복사하면서 플랫폼 이름 추가
              find "$platform_dir" -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.pkg.tar.*" \) | while read file; do
                filename=$(basename "$file")
                # 파일명에 플랫폼 정보가 없으면 추가
                if [[ ! "$filename" =~ (fc42|opensuse|ubuntu|debian|arch) ]]; then
                  # 파일 확장자 처리 (.deb, .rpm, .pkg.tar.zst 등)
                  if [[ "$filename" == *.pkg.tar.* ]]; then
                    # Arch 패키지의 경우 (.pkg.tar.zst, .pkg.tar.xz 등)
                    base_name="${filename%.pkg.tar.*}"
                    ext="pkg.tar.${filename##*.pkg.tar.}"
                    new_filename="${base_name}-${platform_name}.${ext}"
                  else
                    # 일반적인 확장자 (.deb, .rpm 등)
                    ext="${filename##*.}"
                    name="${filename%.*}"
                    new_filename="${name}-${platform_name}.${ext}"
                  fi
                else
                  new_filename="$filename"
                fi
                cp "$file" "final-packages/$new_filename"
                echo "Copied: $filename -> $new_filename"
              done
            fi
          done
          
          # 결과 확인
          echo "=== Final packages for release ==="
          ls -la final-packages/ || echo "No packages found"
          echo "Total packages: $(find final-packages/ -type f | wc -l)"

      - name: Generate release notes
        id: release-notes
        run: |
          # 동적으로 릴리즈 노트 생성 (자동 설치 스크립트)
          cat > release-body.md << 'EOF'
          
          ## 🚀 Quick Install (Recommended)
          
          Install the latest version with a single command on all supported distributions:
          
          ```bash
          # Using curl
          curl -fsSL https://raw.githubusercontent.com/hamonikr/nimf/master/install | sudo bash
          
          # Or using wget
          wget -qO- https://raw.githubusercontent.com/hamonikr/nimf/master/install | sudo -E bash -
          ```
          
          This script automatically:
          - Detects your distribution and installs the appropriate package
          - Handles ibus conflicts (disables ibus-daemon if present)  
          - Configures environment variables for all desktop environments
          - Sets Nimf as the default input method
          
          **Supported Distributions & Architectures:**
          - Ubuntu 24.04+ / Debian 12+ (Bookworm/Trixie) - x86_64, ARM64
          - Fedora 33+ / CentOS / RHEL - x86_64, ARM64
          - openSUSE Leap 15.6+ - x86_64, ARM64
          - Arch Linux / Manjaro - x86_64, ARM64
          
          ---
          
          ## 📦 Manual Package Installation
          
          If you prefer manual installation, download the appropriate package for your distribution from the assets below and install using your package manager.
          
          **Note:** Manual installation requires additional configuration steps. The automatic installation script above is recommended for most users.
          
          EOF
          
          echo "Generated release notes:"
          cat release-body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: final-packages/*
          name: Release ${{ github.ref_name }}
          body_path: release-body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "🎉 Release ${{ github.ref_name }} created successfully!"
          echo "📦 Packages included:"
          find final-packages/ -type f | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "  - $filename ($size)"
          done
          echo "🔗 Release URL: https://github.com/hamonikr/nimf/releases/tag/${{ github.ref_name }}"