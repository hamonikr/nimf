name: Test Multi-Platform Release with Docker Build

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches:
      - dev  # dev ë¸Œëžœì¹˜ì—ì„œ í…ŒìŠ¤íŠ¸

jobs:
  # í†µí•© ë¹Œë“œ job - ëª¨ë“  í”Œëž«í¼ì„ í•œ ë²ˆì— ë¹Œë“œ
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dockerfile: debian.bookworm.Dockerfile
            platform: debian.bookworm
          - dockerfile: debian.trixie.Dockerfile
            platform: debian.trixie
          - dockerfile: ubuntu.2404.Dockerfile
            platform: ubuntu.2404
          - dockerfile: fedora.latest.Dockerfile
            platform: fedora.latest
          - dockerfile: opensuse.Dockerfile
            platform: opensuse
          - dockerfile: arch.Dockerfile
            platform: arch

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build packages with docker build script
        run: |
          # ê°œì„ ëœ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
          chmod +x scripts/build-docker.sh
          
          # Dockerfile ì´ë¦„ì—ì„œ .Dockerfile í™•ìž¥ìž ì œê±°
          DOCKERFILE_NAME="${{ matrix.dockerfile }}"
          PLATFORM_NAME="${DOCKERFILE_NAME%.Dockerfile}"
          
          echo "Building packages for platform: $PLATFORM_NAME"
          ./scripts/build-docker.sh "$PLATFORM_NAME"
          
          # ìƒì„±ëœ íŒ¨í‚¤ì§€ í™•ì¸
          echo "=== Generated packages for $PLATFORM_NAME ==="
          find dist/ -name "*" -type f | sort
          ls -la dist/$PLATFORM_NAME/ || echo "No packages found for $PLATFORM_NAME"

      - name: Upload platform artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist/${{ matrix.platform }}/*
          retention-days: 1

  # ë¦´ë¦¬ì¦ˆ ìƒì„± (í…ŒìŠ¤íŠ¸ìš© - ì‹¤ì œ ë¦´ë¦¬ì¦ˆëŠ” ìƒì„±í•˜ì§€ ì•ŠìŒ)
  test-release-preparation:
    needs: build-packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-packages/
          merge-multiple: false

      - name: Organize packages for release
        run: |
          mkdir -p final-packages
          
          # ê° í”Œëž«í¼ë³„ íŒ¨í‚¤ì§€ë¥¼ final-packagesì— ì •ë¦¬
          for platform_dir in release-packages/packages-*; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/packages-//')
              echo "Processing platform: $platform_name"
              
              # í”Œëž«í¼ë³„ íŒ¨í‚¤ì§€ë¥¼ final-packagesë¡œ ë³µì‚¬í•˜ë©´ì„œ í”Œëž«í¼ ì´ë¦„ ì¶”ê°€
              find "$platform_dir" -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.pkg.tar.*" \) | while read file; do
                filename=$(basename "$file")
                # íŒŒì¼ëª…ì— í”Œëž«í¼ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                if [[ ! "$filename" =~ (fc42|opensuse|ubuntu|debian|arch) ]]; then
                  ext="${filename##*.}"
                  name="${filename%.*}"
                  new_filename="${name}-${platform_name}.${ext}"
                else
                  new_filename="$filename"
                fi
                cp "$file" "final-packages/$new_filename"
                echo "Copied: $filename -> $new_filename"
              done
            fi
          done
          
          # ê²°ê³¼ í™•ì¸
          echo "=== Final packages for release ==="
          ls -la final-packages/ || echo "No packages found"
          echo "Total packages: $(find final-packages/ -type f | wc -l)"

      - name: Generate release notes (test)
        id: release-notes
        run: |
          # ë™ì ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë°©ë²•)
          cat > release-body.md << 'EOF'
          
          ## ðŸš€ ì„¤ì¹˜ ë°©ë²•
          
          ### Ubuntu/Debian
          ```bash
          # ë¦´ë¦¬ì¦ˆ íŽ˜ì´ì§€ì—ì„œ íŒ¨í‚¤ì§€ í™•ì¸ í›„ ë‹¤ìš´ë¡œë“œ
          # ì˜ˆì‹œ: wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf_1.3.10_amd64.deb
          
          # íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf_1.3.10_amd64.deb
          wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-i18n_1.3.10_amd64.deb
          
          # nimf íŒ¨í‚¤ì§€ ì„¤ì¹˜
          sudo dpkg -i nimf_1.3.10_amd64.deb nimf-i18n_1.3.10_amd64.deb
          sudo apt-get install -f  # ì˜ì¡´ì„± í•´ê²°
          ```
          
          ### Fedora
          ```bash
          # ë¦´ë¦¬ì¦ˆ íŽ˜ì´ì§€ì—ì„œ ì •í™•í•œ íŒŒì¼ëª… í™•ì¸ í›„ ë‹¤ìš´ë¡œë“œ
          # ì˜ˆì‹œ: wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1.fc42.x86_64.rpm
          curl -LO https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1.fc42.x86_64.rpm
          sudo dnf install ./nimf-1.3.10-1.fc42.x86_64.rpm
          ```
          
          ### OpenSUSE
          ```bash
          # ë¦´ë¦¬ì¦ˆ íŽ˜ì´ì§€ì—ì„œ ì •í™•í•œ íŒŒì¼ëª… í™•ì¸ í›„ ë‹¤ìš´ë¡œë“œ
          # ì˜ˆì‹œ: wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1.opensuse.x86_64.rpm
          curl -LO https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1.opensuse.x86_64.rpm
          sudo zypper install ./nimf-1.3.10-1.opensuse.x86_64.rpm
          ```
          
          ### Arch Linux
          ```bash
          # ë¦´ë¦¬ì¦ˆ íŽ˜ì´ì§€ì—ì„œ ì •í™•í•œ íŒŒì¼ëª… í™•ì¸ í›„ ë‹¤ìš´ë¡œë“œ
          # ì˜ˆì‹œ: wget https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1-x86_64.pkg.tar.zst
          curl -LO https://github.com/hamonikr/nimf/releases/download/VERSION/nimf-1.3.10-1-x86_64.pkg.tar.zst
          sudo pacman -U nimf-1.3.10-1-x86_64.pkg.tar.zst
          ```
          EOF
          
          echo "Generated release notes:"
          cat release-body.md

      - name: Upload test release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-release-packages
          path: final-packages/*
          retention-days: 7

      - name: Test Summary
        run: |
          echo "ðŸ§ª Test build completed successfully!"
          echo "ðŸ“¦ Packages that would be included in release:"
          find final-packages/ -type f | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "  - $filename ($size)"
          done
          echo "âœ… GitHub Actions workflow validation passed!"