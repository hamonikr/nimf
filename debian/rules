#!/usr/bin/make -f
# -*- makefile -*-
# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

%:
	dh $@ --with autoreconf

override_dh_autoreconf:
	./autogen.sh
	# stale libtool artifacts cause wrong install libdir (/usr/local) to be embedded
	# ensure a clean rebuild of modules so .la files are regenerated with correct --prefix/--libdir
	find . -name '*.la' -delete
	find . -name '*.lo' -delete
	find . -name '*.o' -delete
	find . -name '.libs' -type d -prune -exec rm -rf {} +

override_dh_auto_configure:
	dh_auto_configure -- --prefix=/usr --with-im-config-data --enable-gtk-doc --enable-gtk4 --libdir=/usr/lib/$(DEB_HOST_MULTIARCH)

override_dh_auto_clean:
	rm -rf $(STAMP_DIR) $(SOURCE_DIR)
	dh_clean

override_dh_clean:
	dh_clean
	rm -rf autom4te.cache
	rm -f aclocal.m4 config.log config.status
	rm -rf debian/tmp
	
override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info
	# Check if we're building for Debian (where Qt ABI packages are unavailable)
	@if [ -f /etc/os-release ]; then \
		. /etc/os-release; \
		if [ "$$ID" = "debian" ]; then \
			echo "Debian detected: using dummy ABI packages"; \
			sed -i 's/qt6-base-abi (= [^,]*)/qt6-base-abi-dummy/g' debian/nimf.substvars || true; \
			sed -i 's/qtbase-abi-5-15-[^,]*/qtbase-abi-5-15-13-dummy/g' debian/nimf.substvars || true; \
		fi; \
	fi
	# Make Qt dependencies flexible for different distributions
	sed -i 's/libqt6gui6t64/libqt6gui6t64 | libqt6gui6/g' debian/nimf.substvars || true
	sed -i 's/libqt6widgets6t64/libqt6widgets6t64 | libqt6widgets6/g' debian/nimf.substvars || true 

override_dh_auto_test:
# 	dh_auto_test || true
	echo "Skipping tests"	
